<odoo>
  <data>

    <record id="training_tree" model="ir.ui.view">
        <field name="name">training.tree</field>
        <field name="model">training</field>
        <field name="arch" type="xml">
            <tree decoration-success="state=='training_closed'" default_order="id desc">
              <field name="id" string="ID"/>
              <field name="start"/>
              <field name="partner_id"/>
              <field name="name"/>
              <field name="sales_manager"/>
              <field name="consultant_id"/>
              <field name="scheduled_hours"/>
              <field name="planned_hours"/>
              <field name="effective_hours"/>
              <field name="remaining_hours"/>
              <field name="state"/>
            </tree>
        </field>
    </record>

    <record id="training_search" model="ir.ui.view">
        <field name="name">training.search</field>
        <field name="model">training</field>
        <field name="arch" type="xml">
            <search>
                <field name="id" filter_domain="[('id', '=', self)]"/>
                <field name="name" filter_domain="[('name', 'ilike', self)]"/>
                <field name="partner_id" filter_domain="[('partner_id', 'ilike', self)]"/>
                <field name="sales_manager" filter_domain="[('sales_manager', 'ilike', self)]"/>
                <field name="consultant_id" filter_domain="[('consultant_id', 'ilike', self)]"/>
                <filter string="Formations ouvertes" name="filter_open_training" domain="[('state', '!=', 'training_closed')]"/>
                <filter string="Formations cloturées" name="filter_closed_training" domain="[('state', '=', 'training_closed')]"/>
                <separator/>
                <filter string="Formations OPCO" name="filter_opco" domain="[('opco_file', '!=', False)]"/>
                <filter string="Formations non OPCO" name="filter_non_opco" domain="[('opco_file', '=', False)]"/>
                <separator/>
                <filter string="Archivé" name="inactive" domain="[('active','=', False)]"></filter>
                <group expand="0" string="Group By">
                    <filter string="Client" name="group_by_partner_id" context="{'group_by':'partner_id'}"/>
                    <filter string="Date de début" name="group_by_start" context="{'group_by':'start'}"/>
                    <filter string="Commercial" name="group_by_sales_manager" context="{'group_by':'sales_manager'}"/>
                    <filter string="Consultant" name="group_by_consultant_id" context="{'group_by':'consultant_id'}"/>
                    <filter string="Produit" name="group_by_type_product_id" context="{'group_by':'type_product_id'}"/>
                    <filter string="État" name="group_by_state" context="{'group_by':'state'}"/>
                </group>
            </search>
        </field>
    </record>

    <record id="training_action" model="ir.actions.act_window">
        <field name="name">Formations</field>
        <field name="type">ir.actions.act_window</field>
        <field name="res_model">training</field>
        <field name="view_mode">tree,kanban,form,pivot</field>
        <field name="context">{"search_default_filter_open_training":1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Il n'y a pas de formation
            </p>
        </field>
    </record>

    <record id="training_form" model="ir.ui.view">
        <field name="name">training.form</field>
        <field name="model">training</field>
        <field name="arch" type="xml">
            <form disable_autofocus="1">
                <header>
                  <field name="state" widget="statusbar" statusbar_visible="unassigned,commercial_part,consultant_part,training_in_progress,training_ended,training_closed"/>
                  <button name="button_switch_commercial_part" string="Passer à la partie: commerciale" type="object" class="oe_highlight" attrs="{'invisible': [('state',  '!=', 'unassigned')]}"/>
                  <button name="button_return_unassigned" string="Revenir à la partie: non assigné" type="object" class="oe_highlight" attrs="{'invisible': [('state',  '!=', 'commercial_part')]}"/>
                  <button name="button_switch_consultant_part" string="Passer à la partie: consultant" type="object" class="oe_highlight" attrs="{'invisible': [('state',  '!=', 'commercial_part')]}"/>
                  <button name="button_return_commercial_part" string="Revenir à la partie: commerciale" type="object" class="oe_highlight" attrs="{'invisible': [('state',  '!=', 'consultant_part')]}"/>
                  <button name="button_switch_training_in_progress_part" string="Passer à la partie: formation en cours" type="object" class="oe_highlight" attrs="{'invisible': [('state',  '!=', 'consultant_part')]}"/>
                  <button name="button_return_consultant_part" string="Revenir à la partie: consultant" type="object" class="oe_highlight" attrs="{'invisible': [('state',  '!=', 'training_in_progress')]}"/>
                  <button name="button_switch_training_ended_part" string="Passer à la partie: formation terminée" type="object" class="oe_highlight" attrs="{'invisible': [('state',  '!=', 'training_in_progress')]}"/>
                  <button name="button_return_training_in_progress_part" string="Revenir à la partie: formation en cours" type="object" class="oe_highlight" attrs="{'invisible': [('state',  '!=', 'training_ended')]}"/>
                  <button name="button_switch_training_closed_part" string="Passer à la partie: formation cloturée" type="object" class="oe_highlight" attrs="{'invisible': [('state',  '!=', 'training_ended')]}"/>
                  <button name="button_return_training_ended_part" string="Revenir à la partie: formation terminée" type="object" class="oe_highlight" attrs="{'invisible': [('state',  '!=', 'training_closed')]}"/>

                  <button name="button_download_attendance_sheet" string="Feuille d'émargement" type="object"  icon="fa-download" class="btn-warning" attrs="{'invisible': ['|','|',('state',  '==', 'unassigned'),('state',  '==', 'commercial_part'),('state',  '==', 'training_closed')]}"/>
                  <button name="button_download_certificate_of_attendance" string="Attestation de présence au stage" type="object"  icon="fa-download" class="btn-warning" attrs="{'invisible': ['|','|',('state',  '==', 'unassigned'),('state',  '==', 'commercial_part'),('state',  '==', 'training_closed')]}"/>
                  <button name="download_training_quiz_answers" string="Réponses aux quiz" type="object"  icon="fa-download" class="btn-warning" attrs="{'invisible': [('state',  '!=', 'training_closed')]}"/>
                  <button name="download_all_documents" string="TÉLÉCHARGER TOUS LES DOCUMENTS" type="object"  icon="fa-download" class="btn-warning" attrs="{'invisible': [('state',  '!=', 'training_closed')]}"/>
               </header>
                <sheet>
                  <field name="active" invisible="True"/>
                  <div class="oe_button_box" name="button_box">
                    <field name="sale_id" invisible="True"/>
                    <button name="action_open_sended_mail" string="Mails envoyés" type="object" class="oe_link" icon="fa-envelope-o"/>
                    <button name="action_open_sale_id" string="Ouvrir le devis" type="object" class="oe_link" icon="fa-file-text-o" attrs="{'invisible': [('sale_id', '=', False)]}"/>
                  </div>
                  <p>
                      <input type="checkbox" id="training_show_hide_checkbox" name="training_show_hide_checkbox" onclick="trainingShowHideOldParts()"/>
                      &#032;Afficher les parties antérieures
                  </p>
                  <script type="text/javascript">
                      trainingShowHideOldParts();
                  </script>
                  <group>
                    <field name="sale_id" required="True" readonly="True"/>
                    <field name="name" required="True"/>
                  </group>
                  <!-- Partie non assigné -->
                  <div class="training_major_part" id="unassigned">
                    <separator style="font-size:20px;color: #539314;" string="-&gt; Non assigné" attrs="{'invisible': [('state',  '!=', 'unassigned')]}"/>
                    <separator style="font-size:16px;" string="Non assigné" attrs="{'invisible': [('state',  '=', 'unassigned')]}" />
                    <p attrs="{'invisible': [('state',  '!=', 'unassigned')]}">
                      <strong style="color: #539314;">Étape 1 / 1 :</strong>
                      <span class="training-step-content">
                      Désigner un responsable commercial pour ce dossier.
                      <br/>
                      Le devis signé est à inclure directement dans le devis.
                      </span>
                    </p>
                    <group>
                      <label for="sales_manager" class="training-required"/>
                      <field name="sales_manager" widget="many2one_avatar_user" domain="[('x_sinergis_res_users_is_employee', '=', True)]" attrs="{'readonly': [('state',  '!=', 'unassigned')]}" nolabel="1"/>
                      <label for="signed_quote" class="training-required"/>
                      <field name="signed_quote" nolabel="1"/>
                    </group>
                  </div>
                  <!-- Partie commerciale -->
                  <div attrs="{'invisible': [('state',  '==', 'unassigned')]}" class="training_major_part" id="commercial_part">
                    <separator style="font-size:20px;color: #539314;" string="-&gt; Partie commerciale" attrs="{'invisible': [('state',  '!=', 'commercial_part')]}"/>
                    <separator style="font-size:16px;" string="Partie commerciale" attrs="{'invisible': [('state',  '=', 'commercial_part')]}" />
                    <p attrs="{'invisible': [('state',  '!=', 'commercial_part')]}">
                      <strong style="color: #539314;">Étape 1 / 5 :</strong>
                      <span class="training-step-content">
                      Sélectionner le référent client.<br/>
                      Le client est celui renseigné dans la ligne du devis correspondant à cette formation.
                      </span>
                    </p>
                    <group>
                      <group>
                        <label for="partner_id" class="training-required"/>
                        <field name="partner_id" nolabel="1"/>
                      </group>
                      <group>
                        <label for="partner_manager_id" class="training-required"/>
                        <field name="partner_manager_id" domain="[('parent_id','=',partner_id)]" attrs="{'readonly': ['|',('partner_id',  '=', False),('state',  '!=', 'commercial_part')]}" nolabel="1"/>
                      </group>
                    </group>
                    <p attrs="{'invisible': [('state',  '!=', 'commercial_part')]}">
                      <br/><br/><br/>
                      <strong style="color: #539314;">Étape 2 / 5 :</strong>
                      <span class="training-step-content">
                      <br/>
                      - Sélectionnez le type de formation, le produit ainsi que le plan de formation.
                      <br/>
                      S’assurer qu’un document PDF est renseigné pour ce plan de formation ( Barre supérieure -> Configuration -> Plan de Formation).
                      <br/>
                      - Sélectionner l’OPCO et inclure le document OPCO, cette tâche n’est pas obligatoire et peut-être réalisée plus tard.
                      <br/>
                      - Déposer le diagnostic initial rempli par le client.
                      </span>
                    </p>
                    <group>
                      <group>
                        <label for="company_id" class="training-required"/>
                        <field name="company_id" options="{'no_create': True, 'no_create_edit':True}" attrs="{'readonly': [('state',  '!=', 'commercial_part')]}" nolabel="1"/>
                      </group>
                      <group>
                        <label for="type_id" class="training-required"/>
                        <field name="type_id" options="{'no_create': True, 'no_create_edit':True}" attrs="{'readonly': [('state',  '!=', 'commercial_part')]}" nolabel="1"/>
                      </group>
                      <group>
                        <field name="opco_id" attrs="{'readonly': [('state',  '!=', 'commercial_part')]}"/>
                      </group>
                      <group>
                        <label for="type_product_id" class="training-required"/>
                        <field name="type_product_id" domain="[('type_id','=',type_id)]" attrs="{'readonly': ['|',('type_id',  '=', False),('state',  '!=', 'commercial_part')]}" options="{'no_create': True, 'no_create_edit':True}" nolabel="1"/>
                      </group>
                      <group>
                        <field name="opco_file" attrs="{'readonly': [('state',  '!=', 'commercial_part')]}"/>
                      </group>
                      <group>
                        <label for="type_product_plan_id" class="training-required"/>
                        <field name="type_product_plan_id" domain="['&amp;',('type_id','=',type_id),('product_id','=',type_product_id)]" attrs="{'readonly': ['|',('type_product_id',  '=', False),('state',  '!=', 'commercial_part')]}" options="{'no_create': True, 'no_create_edit':True}" nolabel="1"/>
                      </group>
                      <group>
                        <label for="diagnosis_file" class="training-required"/>
                        <field name="diagnosis_file" attrs="{'readonly': [('state',  '!=', 'commercial_part')]}" nolabel="1"/>
                      </group>
                    </group>
                    <p attrs="{'invisible': [('state',  '!=', 'commercial_part')]}">
                      <br/><br/><br/>
                      <strong style="color: #539314;">Étape 3 / 5 :</strong>
                      <span class="training-step-content">
                      <br/>
                      - Indiquer les participants à la formation : Nom, Fonction, e-mail. Le téléphone est facultatif.
                      </span>
                    </p>
                    <group>
                      <field name="training_participants" attrs="{'invisible': [('state',  '!=', 'commercial_part')]}" readonly="False" >
                      </field>
                    </group>
                    <p attrs="{'invisible': [('state',  '!=', 'commercial_part')]}">
                      <br/><br/><br/>
                      <strong style="color: #539314;">Étape 4 / 5 :</strong>
                      <span class="training-step-content">
                        <br/>
                        - Remplir les champs de rédaction de la convention. La durée est fixée à celle présente dans le devis.
                        <br/>
                        La signature présente à la fin de la convention sera celle du signataire interne.
                        <br/>
                        - Télécharger la convention pour la vérifier et l’envoyer au client.
                      </span>
                    </p>
                    <div style="margin-left:30px;" attrs="{'invisible': [('state',  '!=', 'commercial_part')]}">
                      <separator string="Rédaction de la convention" style="color:#2554eb;font-size:15px;"/>
                      <group>
                      <label for="course_title" class="training-required"/>
                      <field name="course_title" nolabel="1"/>
                      <label for="location" class="training-required"/>
                      <field name="location" options="{'no_create': True, 'no_create_edit':True}" nolabel="1"/>
                      </group>
                      <group>
                        <group>
                          <label for="start" class="training-required"/>
                          <field name="start" nolabel="1"/>
                        </group>
                        <group>
                          <label for="end" class="training-required"/>
                          <field name="end" nolabel="1"/>
                        </group>
                        <group>
                          <label for="agreement_internal_signer" class="training-required"/>
                          <field name="agreement_internal_signer" domain="['&amp;',('user_id.x_sinergis_res_users_is_employee', '=', True),('company_id','=',company_id)]" options="{'no_create': True, 'no_create_edit':True}" nolabel="1"/>
                        </group>
                        <group>
                          <label for="duration" class="training-required"/>
                          <field name="duration" nolabel="1"/>
                        </group>
                        <group>
                        </group>
                        <group>
                          <field name="duration_hours"/>
                        </group>
                      </group>
                      <button name="download_training_agreement" string="Télécharger la convention de formation" type="object" class="oe_highlight"/>
                      <button name="send_training_agreement" string="Envoyer la convention de formation au référent client" type="object" class="oe_highlight oe_right"/>
                    </div>
                    <br/>
                    <p attrs="{'invisible': [('state',  '!=', 'commercial_part')]}">
                      <br/><br/><br/>
                      <strong style="color: #539314;">Étape 5 / 5 :</strong>
                      <span class="training-step-content">
                        Déposer la convention de formation signée par le client dans le champ ci-dessous.
                      </span>
                    </p>
                    <group>
                      <label for="signed_agreement" class="training-required"/>
                      <field name="signed_agreement" attrs="{'readonly': [('state',  '!=', 'commercial_part')]}" nolabel="1"/>
                    </group>
                  </div>
                  <!-- Partie consultant -->
                  <div attrs="{'invisible': ['|',('state',  '==', 'unassigned'),('state',  '==', 'commercial_part')]}" class="training_major_part" id="consultant_part">
                    <separator style="font-size:20px;color: #539314;" string="-&gt; Partie consultant" attrs="{'invisible': [('state',  '!=', 'consultant_part')]}"/>
                    <separator style="font-size:16px;" string="Partie consultant" attrs="{'invisible': [('state',  '=', 'consultant_part')]}" />
                    <p attrs="{'invisible': [('state',  '!=', 'consultant_part')]}">
                      <strong style="color: #539314;">Étape 1 / 4 :</strong>
                      <span class="training-step-content">
                        Sélectionner le consultant en charge de la formation.
                      </span>
                    </p>
                    <group>
                      <label for="consultant_id" class="training-required"/>
                      <field name="consultant_id" attrs="{'readonly': [('state',  '!=', 'consultant_part')]}" domain="[('x_sinergis_res_users_job','=','CONSULTANT')]" nolabel="1"/>
                    </group>
                    <p attrs="{'invisible': [('state',  '!=', 'consultant_part')]}">
                      <br/><br/><br/>
                      <strong style="color: #539314;">Étape 2 / 4 :</strong>
                      <span class="training-step-content">
                        <br/>
                        - Indiquer si la formation est à distance ou en présentiel.
                        <br/>
                        - Si la formation est à distance, indiquer le lien de connexion.
                        <br/>
                        - Si la formation est en présentiel, indiquer sa localisation.
                        <br/>
                        Cette adresse correspond au lieu où se déroulera la formation. Merci de bien vérifier son exactitude!
                      </span>
                    </p>
                    <group>
                      <group>
                        <field name="remote_learning" attrs="{'readonly': [('state',  '!=', 'consultant_part')]}"/>
                      </group>
                      <group>
                        <label for="remote_learning_link" class="training-required" attrs="{'invisible': [('remote_learning',  '==', False)]}"/>
                        <field name="remote_learning_link" attrs="{'invisible': [('remote_learning',  '==', False)], 'required': [('remote_learning',  '=', True)], 'readonly': [('state',  '!=', 'consultant_part')]}" nolabel="1"/>
                      </group>
                    </group>
                    <div attrs="{'invisible': [('remote_learning',  '=', True)]}">
                      <group>
                        <group>
                          <label for="location_selection" class="training-required"/>
                          <field name="location_selection" attrs="{'readonly': [('state',  '!=', 'consultant_part')]}" nolabel="1"/>
                        </group>
                        <group>
                            <div attrs="{'invisible': [('location_selection',  '=', 'company')]}">
                                  <div class="o_address_format" name="div_address">
                                      <field name="location_street" placeholder="Rue..." class="o_address_street" attrs="{'readonly': [('location_selection',  '=', 'client')]}" force_save="1"/>
                                      <field name="location_street2" placeholder="Rue 2..." class="o_address_street" attrs="{'readonly': [('location_selection',  '=', 'client')]}" force_save="1"/>
                                      <field name="location_city" placeholder="Ville" class="o_address_city" attrs="{'readonly': [('location_selection',  '=', 'client')]}" force_save="1"/>
                                      <field name="location_zip" placeholder="Code postal" class="o_address_zip" attrs="{'readonly': [('location_selection',  '=', 'client')]}" force_save="1"/>
                                      <field name="location_country_id" placeholder="Pays" class="o_address_country" options="{&quot;no_open&quot;: True, &quot;no_create&quot;: True}" attrs="{'readonly': [('location_selection',  '=', 'client')]}" force_save="1"/>
                                  </div>
                            </div>
                        </group>
                      </group>
                    </div>
                    <p attrs="{'invisible': [('state',  '!=', 'consultant_part')]}">
                      <br/><br/><br/>
                      <strong style="color: #539314;">Étape 3 / 4 :</strong>
                      <span class="training-step-content">
                      Planifier les créneaux de formation, les alertes s’affichent en rouge.
                      </span>
                    </p>
                    <field name="planned_hours_alert" style="color: red;"/>
                    <group>
                      <label for="planned_hours_ids" class="training-required"/>
                      <field name="planned_hours_ids" nolabel="1">
                        <tree string="Heures planifiées" default_order="start asc">
                          <field name="user_id" string="Organisateur"/>
                          <field name="start" string="Début"/>
                          <field name="stop" string="Fin"/>
                          <field name="duration" widget="float_time"/>
                          <button
                          name="training_remove_event_button"
                          string=""
                          class="oe_highlight btn-secondary"
                          type="object"
                          icon="fa-trash-o"
                          confirm="Êtes-vous sûr de supprimer cet évènement du calendrier ?" attrs="{'invisible': [('parent.state',  '!=', 'consultant_part')]}"/>
                        </tree>
                      </field>
                    </group>
                    <p attrs="{'invisible': [('state',  '!=', 'consultant_part')]}">Aide : Pour planifier des heures veuillez cliquer sur "Planifier un créneau de formation" ci-dessous et placer vos créneaux ou passer directement via l'application "Calendrier". Veillez à ce que la coche "Est une formation" soit cochée et que la bonne formation soit sélectionnée.</p>
                    <button name="button_plan_training_slot" string="Planifier un créneau de formation" type="object" icon="fa-plus-square" class="oe_highlight oe_right" attrs="{'invisible': [('state',  '!=', 'consultant_part')]}"/>
                    <p attrs="{'invisible': [('state',  '!=', 'consultant_part')]}">
                      <br/><br/><br/>
                      <strong style="color: #539314;">Étape 4 / 4 :</strong>
                      <span class="training-step-content">
                      <br/>
                      Envoyer les invitations aux participants par mail grâce au bouton «Envoyer les invitations aux participants».
                      <br/>
                      Vous pouvez aussi envoyer les invitations individuellement avec le bouton «Envoyer une invitation».
                      </span>
                    </p>
                      <field name="training_participants" readonly="True" force_save="1" attrs="{'invisible': [('state',  '!=', 'consultant_part')]}" >
                      </field>
                    <button name="send_invitation_participants" string="Envoyer les invitations aux participants" type="object" class="oe_highlight oe_right" confirm="Vous allez envoyer les invitations à tous les participants où l'invitation n'a pas encore été envoyée. Souhaitez-vous continuer ?" attrs="{'invisible': [('state',  '!=', 'consultant_part')]}"/>
                  </div>
                  <!-- Formation en cours -->
                  <div attrs="{'invisible': [('state',  '!=', 'training_in_progress')]}" class="training_major_part" id="training_in_progress">
                  <separator style="font-size:20px;color: #539314;" string="-&gt; Formation en cours" attrs="{'invisible': [('state',  '!=', 'training_in_progress')]}"/>
                  <separator style="font-size:16px;" string="Formation en cours" attrs="{'invisible': [('state',  '=', 'training_in_progress')]}" />
                  <p attrs="{'invisible': [('state',  '!=', 'training_in_progress')]}">
                      <strong style="color: #539314;">Étape 1 / 1 :</strong>
                      <span class="training-step-content">
                      Envoyer les quiz de positionnement aux participants.
                      </span>
                  </p>
                  <group>
                    <field name="training_participants" force_save="1" >
                    </field>
                  </group>
                  <button name="send_diagnostic_quiz_participants" string="Envoyer les quiz de positionnement" type="object" class="oe_highlight oe_right" confirm="Vous allez envoyer les quiz à tous les participants où celui-ci n'a pas encore été envoyée. Souhaitez-vous continuer ?" attrs="{'invisible': [('state',  '!=', 'training_in_progress')]}"/>
                </div>
                <!-- Formation terminée -->
                <div attrs="{'invisible': ['|','|','|',('state',  '==', 'unassigned'),('state',  '==', 'commercial_part'),('state',  '==', 'consultant_part'),('state',  '==', 'training_in_progress')]}" class="training_major_part" id="training_ended">
                <separator style="font-size:20px;color: #539314;" string="-&gt; Formation terminée" attrs="{'invisible': [('state',  '!=', 'training_ended')]}"/>
                <separator style="font-size:16px;" string="Formation terminée" attrs="{'invisible': [('state',  '=', 'training_ended')]}" />
                <p attrs="{'invisible': [('state',  '!=', 'training_ended')]}">
                      <strong style="color: #539314;">Étape 1 / 4 :</strong>
                      <span class="training-step-content">
                      <br/>
                      Envoyer les quiz de fin de formation (quiz d’évaluation des acquis et quiz d’évaluation de la formation) aux participants.
                      </span>
                </p>
                <p attrs="{'invisible': [('state',  '!=', 'training_ended')]}">
                      <br/>
                      <strong style="color: #539314;">Étape 2 / 4 :</strong>
                      <span class="training-step-content">
                      <br/>
                      Noter chaque participant en cliquant dessus et en sélectionnant une note d’engagement et de compétences.
                      </span>
                </p>
                <field name="training_participants" readonly="False" force_save="1" attrs="{'invisible': [('state',  '!=', 'training_ended')]}" >
                </field>
                  <button name="send_training_ended_participants" string="Envoyer les mails aux participants" type="object" class="oe_highlight oe_right" confirm="Vous allez envoyer les mails à tous les participants où celui-ci n'a pas encore été envoyée. Souhaitez-vous continuer ?" attrs="{'invisible': [('state',  '!=', 'training_ended')]}"/>
                <p attrs="{'invisible': [('state',  '!=', 'training_ended')]}">
                      <br/><br/><br/>
                      <strong style="color: #539314;">Étape 3 / 4 :</strong>
                      <span class="training-step-content">
                      <br/>
                      Noter le déroulement de la formation et si des difficultés ont été rencontrées, le préciser.
                      </span>
                </p>
                  
                  <div style="margin-left:30px;">
                    <separator string="Évaluation de la formation par le consultant" style="color:#2554eb;font-size:15px;"/>
                    <group>
                      <group>
                        <label for="evaluating_training_course" class="training-required"/>
                        <field name="evaluating_training_course" attrs="{'readonly': [('state',  '!=', 'training_ended')]}" nolabel="1"/>
                      </group>
                      <group>
                        <field name="difficulties_training_course" attrs="{'readonly': [('state',  '!=', 'training_ended')]}"/>
                      </group>
                    </group>
                    <button name="download_training_evaluation" string="Télécharger l'évaluation du consultant" type="object" class="oe_highlight oe_right"/>
                  </div>
                <p attrs="{'invisible': [('state',  '!=', 'training_ended')]}">
                      <br/><br/><br/>
                      <strong style="color: #539314;">Étape 4 / 4 :</strong>
                      <span class="training-step-content">
                      <br/>
                      Ajouter la ou les feuilles d’émargement remplie(s) et sauvegarder. Il faut au moins une feuille d’émargement.
                      </span>
                </p>
                  <div style="margin-left:30px;">
                        <label for="signed_attendance_sheets" class="training-required"/>
                        <field name="signed_attendance_sheets" attrs="{'readonly': [('state',  '!=', 'training_ended')]}" nolabel="1">
                          <tree>
                            <field name="name" invisible="True"/>
                            <field name="file" filename="name" widget="binary"/>
                          </tree>
                          <form>
                            <group>
                                <field name="name" invisible="True"/>
                                <field name="file" filename="name"/>
                            </group>
                          </form>
                        </field>
                  </div>
                </div>
                <!-- Formation cloturée -->
                <div attrs="{'invisible': ['|','|','|','|',('state',  '==', 'unassigned'),('state',  '==', 'commercial_part'),('state',  '==', 'consultant_part'),('state',  '==', 'training_in_progress'),('state',  '==', 'training_ended')]}" class="training_major_part" id="training_closed">
                  <separator style="font-size:20px;color: #539314;" string="-&gt; Formation cloturée"/>
                  <group>
                    <field name="training_participants" readonly="True" force_save="1" attrs="{'invisible': [('state',  '!=', 'training_closed')]}" >
                      <tree string="Liste des participants" decoration-success="is_rated==True" delete="0">
                            <button
                              name="remove_participant"
                              string=""
                              class="oe_highlight btn-secondary"
                              type="object"
                              icon="fa-trash-o"
                              confirm="Êtes-vous sûr de supprimer ce participant ?"
                              attrs="{'invisible': ['&amp;','&amp;',('parent.state',  '!=', 'commercial_part'),('parent.state',  '!=', 'training_in_progress'),('parent.state',  '!=', 'training_ended')]}"/>
                            <field name="name"/>
                            <field name="email"/>
                            <!--Partie consultant-->
                            <field name="invitation_sent" readonly="True" attrs="{'column_invisible': [('parent.state',  '!=', 'consultant_part')]}"/>
                            <field name="positioning_quiz_received" readonly="True" attrs="{'column_invisible': [('parent.state',  '!=', 'consultant_part')]}"/>
                            <button name="send_invitation_individual" string="Envoyer une invitation" type="object" class="oe_highlight oe_right" confirm="Vous allez envoyer une invitation, souhaitez-vous continuer" attrs="{'column_invisible': [('parent.state',  '!=', 'consultant_part')]}"/>
                            <!--Formation en cours-->
                            <field name="diagnostic_quiz_sent" readonly="True" attrs="{'column_invisible': [('parent.state',  '!=', 'training_in_progress')]}"/>
                            <field name="diagnostic_received" readonly="True" attrs="{'column_invisible': [('parent.state',  '!=', 'training_in_progress')]}"/>
                            <button name="send_diagnostic_quiz_individual" string="Envoyer le quiz de positionnement" type="object" class="oe_highlight oe_right" confirm="Vous allez envoyer un quiz de positionnement, souhaitez-vous continuer ?" attrs="{'column_invisible': [('parent.state',  '!=', 'training_in_progress')]}"/>
                            <!--Formation terminée-->
                            <field name="training_ended_sent" attrs="{'column_invisible': [('parent.state',  '!=', 'training_ended')]}"/>
                            <field name="prior_learning_quiz_received" attrs="{'column_invisible': [('parent.state',  '!=', 'training_ended')]}"/>
                            <field name="training_evaluation_received" attrs="{'column_invisible': [('parent.state',  '!=', 'training_ended')]}"/>
                            <field name="is_rated" attrs="{'column_invisible': [('parent.state',  '!=', 'training_ended')]}"/>
                            <button name="send_training_ended_individual" string="Envoyer les quiz" type="object" class="oe_highlight oe_right" confirm="Vous allez envoyer les quiz d'évaluation, souhaitez-vous continuer ?" attrs="{'column_invisible': [('parent.state',  '!=', 'training_ended')]}"/>
                            <button name="open_participant_button" string="Voir" type="object"  icon="fa-eye" class="btn-warning" attrs="{'invisible': [('parent.state',  '=', 'commercial_part')]}"/>
                      </tree>
                    </field>
                </group>
                  <group>
                    <field name="training_closed_date"/>
                  </group>
                  <div style="margin-left:30px;">
                    <p>Les quiz seront envoyé automatiquement 30 jours et 60 jours après la clôture de la formation, vous pouvez forcer l'envoi via les boutons "Envoyer l'évaluation maintenant" et "Envoyer le quiz maintenant".</p>
                    <separator string="Évaluation à froid du client (J+30)" style="color:#2554eb;font-size:15px;"/>
                    <group>
                      <group>
                        <field name="delayed_assessment_sent"/>
                      </group>
                      <group>
                        <field name="delayed_assessment_received"/>
                      </group>
                    </group>
                    <button name="send_delayed_assessment_client" string="Envoyer l'évaluation maintenant" type="object" class="oe_highlight oe_right" confirm="Vous allez envoyer l'évaluation au client. Cette tâche est normalement effectuée automatiquement 30 jours après la fin de la formation. Souhaitez-vous continuer ?" attrs="{'invisible': [('delayed_assessment_received',  '=', True)]}"/>
                  </div>
                  <div style="margin-left:30px;">
                    <separator string="Évaluation de l'OPCO (J+60)" style="color:#2554eb;font-size:15px;"/>
                    <group>
                      <group>
                        <field name="opco_quiz_sent"/>
                      </group>
                      <group>
                        <field name="opco_quiz_received"/>
                      </group>
                    </group>
                    <button name="send_opco_quiz" string="Envoyer le quiz maintenant" type="object" class="oe_highlight oe_right" confirm="Vous allez envoyer le quiz à l'OPCO maintenant. Cette tâche est normalement effectuée automatiquement 60 jours après la fin de la formation. Souhaitez-vous continuer ?" attrs="{'invisible': [('opco_quiz_received',  '=', True)]}"/>
                  </div>
                  <div style="margin-left:30px;" attrs="{'invisible': ['&amp;',('answer_delayed_assessment',  '==', False),('answer_opco_quiz',  '==', False)]}">
                    <separator string="Réponses aux quiz" style="color:green;"/>
                    <group>
                      <!-- Le système de notes pour ces quiz est déjà en place -->
                      <field name="answer_delayed_assessment" readonly="True"/>
                      <field name="answer_opco_quiz" readonly="True"/>
                    </group>
                  </div>
                </div>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids"/>
                    <field name="message_ids"/>
                </div>
            </form>
        </field>
    </record>

    <!--=====PIVOT VIEW=====-->

    <!-- _TEMP TO REMOVE -->
    <!--<record id="training_pivot" model="ir.ui.view">
        <field name="name">training.pivot</field>
        <field name="type">pivot</field>
        <field name="model">training</field>
        <field name="arch" type="xml">
            <pivot string="Formations">

            </pivot>
        </field>
    </record>-->

    <!--===============Stats filters=============== -->

    <!--Pivot filters-->
    <record id="filter_all_time" model="ir.filters">
        <field name="name">Temps total</field>
        <field name="model_id">training</field>
        <field name="domain"></field>
        <field name="user_id" eval="False"/>
        <field name="context">{'group_by': [], 'pivot_measures': ['duration'], 'pivot_column_groupby': [], 'pivot_row_groupby': []}</field>
    </record>

    <!--<record id="filter_all_amount" model="ir.filters">
        <field name="name">Montant total</field>
        <field name="model_id">training</field>
        <field name="domain"></field>
        <field name="user_id" eval="False"/>
        <field name="context">{'group_by': [], 'pivot_measures': ['sale_price_total'], 'pivot_column_groupby': [], 'pivot_row_groupby': []}</field>
    </record>-->

    <!--<record id="filter_product_participant" model="ir.filters">
        <field name="name">Participants par produit</field>
        <field name="model_id">training</field>
        <field name="domain"></field>
        <field name="user_id" eval="False"/>
        <field name="context">{'group_by': [], 'pivot_measures': ['participants_count'], 'pivot_column_groupby': [], 'pivot_row_groupby': ['type_product_id']}</field>
    </record>-->

    <record id="filter_product_time" model="ir.filters">
        <field name="name">Temps par produit</field>
        <field name="model_id">training</field>
        <field name="domain"></field>
        <field name="user_id" eval="False"/>
        <field name="context">{'group_by': [], 'pivot_measures': ['duration'], 'pivot_column_groupby': [], 'pivot_row_groupby': ['type_product_id']}</field>
    </record>

    <!--<record id="filter_all_participants" model="ir.filters">
        <field name="name">Total des participants</field>
        <field name="model_id">training</field>
        <field name="domain"></field>
        <field name="user_id" eval="False"/>
        <field name="context">{'group_by': [], 'pivot_measures': ['participants_count'], 'pivot_column_groupby': [], 'pivot_row_groupby': []}</field>
    </record>-->

    <record id="filter_consultants_list" model="ir.filters">
        <field name="name">Liste des consultants</field>
        <field name="model_id">training</field>
        <field name="domain"></field>
        <field name="user_id" eval="False"/>
        <field name="context">{'group_by': [], 'pivot_measures': ['duration'], 'pivot_column_groupby': [], 'pivot_row_groupby': ['consultant_id']}</field>
    </record>

    <record id="filter_consultants_year" model="ir.filters">
        <field name="name">Liste des consultants par année</field>
        <field name="model_id">training</field>
        <field name="domain"></field>
        <field name="user_id" eval="False"/>
        <field name="context">{'group_by': [], 'pivot_measures': ['duration'], 'pivot_column_groupby': [], 'pivot_row_groupby': ['start:year', 'consultant_id']}</field>
    </record>

    <record id="filter_consultants_product" model="ir.filters">
        <field name="name">Liste des consultants par produit</field>
        <field name="model_id">training</field>
        <field name="domain"></field>
        <field name="user_id" eval="False"/>
        <field name="context">{'group_by': [], 'pivot_measures': ['duration'], 'pivot_column_groupby': [], 'pivot_row_groupby': ['type_product_id', 'consultant_id']}</field>
    </record>



    <record id="training_participants_form" model="ir.ui.view">
        <field name="name">training.participants.form</field>
        <field name="model">training.participants</field>
        <field name="arch" type="xml">
          <form>
            <group>
              <separator string="Utiliser un contact existant" style="font-size:16px;" />
            </group>
              <label for="partner_contact_id" string="Référence du contact : " style="font-size: 16px;"/>
              <field name="partner_contact_id" style="font-size: 16px;" nolabel="1"/>
              <p>Si la référence du contact n'existe pas, vous pouvez l'ajouter manuellement ci-dessous.</p>
            <group>
              <separator string="Données du contact"/>
              <field name="training_id" invisible="True"/>
              <field name="training_state" invisible="True"/>
              <label for="name" class="training-required"/>
              <field name="name" required="True" nolabel="1"/>
              <label for="position" class="training-required"/>
              <field name="position" required="True" nolabel="1"/>
              <label for="email" class="training-required"/>
              <field name="email" required="True" nolabel="1"/>
              <field name="phone"/>
            </group>
            <div style="margin-left:30px;" attrs="{'invisible': ['&amp;',('training_state',  '!=', 'training_ended'),('training_state',  '!=', 'training_closed')]}">
            <separator string="Évaluation"/>
            <group>
                <group>
                  <field name="evaluation_engagment_mark" style="background:orange;color:black;"/>
                </group>
                <group>
                  <field name="training_end_mark" style="background:orange;color:black;"/>
                </group>
            </group>
            <group>
                <group>
                    <ul>
                      <li>A Exemplaire</li>
                      <li>B Satisfaisant</li>
                      <li>C Perfectible</li>
                      <li>D Insuffisant</li>
                    </ul>
                </group>
                <group>
                    <ul>
                      <li>A Très satisfaisant</li>
                      <li>B Satisfaisant</li>
                      <li>C Perfectible</li>
                      <li>D Insuffisant</li>
                    </ul>
                </group>
            </group>
            </div>
            <div attrs="{'invisible': ['|',('training_state',  '=', 'unassigned'),('training_state',  '=', 'commercial_part')]}">
              <separator string="Réponses aux quiz"/>
              <field name="diagnostic_received" invisible="True"/>
              <field name="positioning_quiz_received" invisible="True"/>
              <field name="prior_learning_quiz_received" invisible="True"/>
              <field name="training_evaluation_received" invisible="True"/>
              <div attrs="{'invisible': [('positioning_quiz_received',  '=', False)]}" style="margin-left:20px;">
                <separator string="Quiz de diagnostic" style="font-size: 16px;"/>
                <div attrs="{'invisible': [('mark_positioning_quiz',  '=', -1)]}" style="color:#DCC222; font-size: 16px;">Note : <field name="mark_positioning_quiz" readonly="True"/> / 20</div>
                <field name="answer_positioning_quiz"/>
              </div>
              <div attrs="{'invisible': [('diagnostic_received',  '=', False)]}" style="margin-left:20px;">
                <separator string="Quiz de positionnement" style="font-size: 16px;"/>
                <div attrs="{'invisible': [('mark_quiz_diagnostic',  '=', -1)]}" style="color:#DCC222; font-size: 16px;">Note : <field name="mark_quiz_diagnostic" readonly="True"/> / 20</div>
                <field name="answer_quiz_diagnostic"/>
              </div>
              <div attrs="{'invisible': [('prior_learning_quiz_received',  '=', False)]}" style="margin-left:20px;">
                <separator string="Quiz de validation des acquis" style="font-size: 16px;"/>
                <div attrs="{'invisible': [('mark_prior_learning_quiz',  '=', -1)]}" style="color:#DCC222; font-size: 16px;">Note : <field name="mark_prior_learning_quiz" readonly="True"/> / 20</div>
                <field name="answer_prior_learning_quiz"/>
              </div>
              <div attrs="{'invisible': [('training_evaluation_received',  '=', False)]}" style="margin-left:20px;">
                <separator string="Quiz évaluation formation" style="font-size: 16px;"/>
                <div attrs="{'invisible': [('mark_training_evaluation',  '=', -1)]}" style="color:#DCC222; font-size: 16px;">Note : <field name="mark_training_evaluation" readonly="True"/> / 20</div>
                <field name="answer_training_evaluation"/>
              </div>
            </div>
          </form>
        </field>
    </record>

    <!--Configuration Type/Produit/Plan de formation-->
    <record id="training_type_action" model="ir.actions.act_window">
        <field name="name">Type de formation</field>
        <field name="type">ir.actions.act_window</field>
        <field name="res_model">training.type</field>
        <field name="view_mode">tree,form</field>
    </record>
    <record id="training_type_product_action" model="ir.actions.act_window">
        <field name="name">Produit</field>
        <field name="type">ir.actions.act_window</field>
        <field name="res_model">training.type.product</field>
        <field name="view_mode">tree,form</field>
    </record>
    <record id="training_type_product_plan_action" model="ir.actions.act_window">
        <field name="name">Plan de formation</field>
        <field name="type">ir.actions.act_window</field>
        <field name="res_model">training.type.product.plan</field>
        <field name="view_mode">tree,form</field>
    </record>

    <record id="training_type_product_plan_form" model="ir.ui.view">
        <field name="name">training.type.product.plan.form</field>
        <field name="model">training.type.product.plan</field>
        <field name="arch" type="xml">
          <form>
            <sheet>
              <group>
                <field name="type_id"/>
                <field name="product_id" attrs="{'readonly': [('type_id',  '=', False)]}" domain="[('type_id','=',type_id)]"/>
                <field name="name"/>
                <field name="training_plan_file"/>
              </group>
            </sheet>
          </form>
        </field>
    </record>

    <!--Configuration localisation de la formation-->
    <record id="training_location_action" model="ir.actions.act_window">
        <field name="name">Localisation de la formation</field>
        <field name="type">ir.actions.act_window</field>
        <field name="res_model">training.location</field>
        <field name="view_mode">tree,form</field>
    </record>

    <!--Configuration OPCO-->
    <record id="training_opco_action" model="ir.actions.act_window">
        <field name="name">Liste des OPCO</field>
        <field name="type">ir.actions.act_window</field>
        <field name="res_model">training.opco</field>
        <field name="view_mode">tree,form</field>
    </record>

    <!--Configuration Signataires interne de la convention-->
    <record id="training_agreement_internal_signer_action" model="ir.actions.act_window">
        <field name="name">Liste des signataires internes</field>
        <field name="type">ir.actions.act_window</field>
        <field name="res_model">training.agreement_internal_signer</field>
        <field name="view_mode">tree,form</field>
    </record>

    <record id="training_agreement_internal_signer_action_tree" model="ir.ui.view">
        <field name="name">training.agreement_internal_signer_action.tree</field>
        <field name="model">training.agreement_internal_signer</field>
        <field name="arch" type="xml">
            <tree>
              <field name="user_id"/>
              <field name="company_id"/>
            </tree>
        </field>
    </record>

    <record id="training_agreement_internal_signer_action_form" model="ir.ui.view">
        <field name="name">training.agreement_internal_signer_action.form</field>
        <field name="model">training.agreement_internal_signer</field>
        <field name="arch" type="xml">
            <form>
              <group>
                <group>
                  <field name="user_id" domain="[('x_sinergis_res_users_is_employee', '=', True)]" options="{'no_create': True, 'no_create_edit':True}"/>
                </group>
                <group>
                  <field name="signature"/>
                </group>
                <group>
                  <field name="company_id" options="{'no_create': True, 'no_create_edit':True}"/>
                </group>
              </group>
            </form>
        </field>
    </record>

    <record id="training_disability_referent_action" model="ir.actions.act_window">
        <field name="name">Référents handicape</field>
        <field name="type">ir.actions.act_window</field>
        <field name="res_model">training.disability_referent</field>
        <field name="view_mode">tree,form</field>
    </record>

    <record id="training_disability_referent_action_tree" model="ir.ui.view">
        <field name="name">training.disability_referent_action.tree</field>
        <field name="model">training.disability_referent</field>
        <field name="arch" type="xml">
            <tree>
              <field name="user_id"/>
              <field name="phone"/>
              <field name="mail"/>
            </tree>
        </field>
    </record>

    <record id="training_agreement_internal_signer_action_form" model="ir.ui.view">
        <field name="name">training.disability_referent_action.form</field>
        <field name="model">training.disability_referent</field>
        <field name="arch" type="xml">
            <form>
              <group>
                <group>
                  <field name="user_id" domain="[('x_sinergis_res_users_is_employee', '=', True)]" options="{'no_create': True, 'no_create_edit':True}"/>
                </group>
                <group>
                  <field name="phone"/>
                </group>
                <group>
                  <field name="mail" options="{'no_create': True, 'no_create_edit':True}"/>
                </group>
              </group>
            </form>
        </field>
    </record>
    

    <!--==========AUTOMATED ACTIONS==========-->

    <record id="automating_closed_training" model="ir.cron">
        <field name="name">Automatisation - Formation cloturée</field>
        <field name="model_id" ref="model_training"/>
        <field name="type">ir.actions.server</field>
        <field name="state">code</field>
        <field name="code">model.automating_closed_training()</field>
        <field name="interval_number">1</field>
        <field name="interval_type">days</field>
        <field name="numbercall">-1</field>
    </record>

    <!--==========MENU==========-->

    <!--Training-->
    <menuitem id="training_root"
              name="Formations"
              web_icon="training,static/description/icon.png"
              sequence="30"/>

    <menuitem id="training_training_root"
              parent="training_root"
              name="Formations"
              action="training_action"
              sequence="10"/>
    <!--Configuration-->
    <menuitem id="training_configuration_root"
              parent="training_root"
              name="Configuration"
              sequence="20"/>
    <!--Configuration Type/Produit/Plan de formation-->
    <menuitem id="training_configuration_type"
              parent="training_configuration_root"
              name="Type de formation"
              action="training_type_action"
              sequence="5"/>
    <menuitem id="training_configuration_type_product"
              parent="training_configuration_root"
              name="Produit"
              action="training_type_product_action"
              sequence="5"/>
    <menuitem id="training_configuration_type_product_plan"
              parent="training_configuration_root"
              name="Plan de formation"
              action="training_type_product_plan_action"
              sequence="5"/>
    <!--Configuration Localisation de la formation-->
    <menuitem id="training_configuration_location"
              parent="training_configuration_root"
              name="Localisation"
              action="training_location_action"
              sequence="10"/>


    <!--Configuration - OPCO-->

    <menuitem id="training_configuration_opco"
              parent="training_configuration_root"
              name="OPCO"
              action="training_opco_action"
              sequence="10"/>

    <!--Configuration - Signataires de la convention-->

    <menuitem id="training_configuration_agreement_internal_signer"
              parent="training_configuration_root"
              name="Signataires de la convention"
              action="training_agreement_internal_signer_action"
              sequence="10"/>

    <!--Configuration - Référents handicape-->

    <menuitem id="training_configuration_disability_referent"
              parent="training_configuration_root"
              name="Référents handicape"
              action="training_disability_referent_action"
              sequence="10"/>



  </data>
</odoo>





